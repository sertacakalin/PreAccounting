<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Flow Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      cursor: pointer;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #005a9e;
    }
    .log {
      background: #252526;
      border: 1px solid #3e3e42;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      max-height: 500px;
      overflow-y: auto;
    }
    .log pre {
      margin: 5px 0;
      white-space: pre-wrap;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    .info { color: #9cdcfe; }
  </style>
</head>
<body>
  <h1>üîç Auth Flow Test - Check if Token is Sent to Login</h1>

  <div>
    <h2>Test 1: Login WITHOUT existing token</h2>
    <button onclick="testLoginWithoutToken()">Test Login (Clean)</button>
  </div>

  <div>
    <h2>Test 2: Login WITH existing token in localStorage</h2>
    <button onclick="testLoginWithToken()">Test Login (With Stored Token)</button>
  </div>

  <div>
    <h2>Test 3: Access Protected Endpoint</h2>
    <button onclick="testProtectedEndpoint()">Test Dashboard (Should have token)</button>
  </div>

  <div>
    <button onclick="clearLogs()">Clear Logs</button>
    <button onclick="clearStorage()">Clear localStorage</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    const API_URL = 'http://localhost:8081';
    const logEl = document.getElementById('log');

    function log(message, type = 'info') {
      const pre = document.createElement('pre');
      pre.className = type;
      pre.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(pre);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLogs() {
      logEl.innerHTML = '';
    }

    function clearStorage() {
      localStorage.clear();
      log('localStorage cleared', 'warning');
    }

    async function testLoginWithoutToken() {
      log('=== TEST 1: Login WITHOUT Token ===', 'info');
      localStorage.removeItem('token');

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Deliberately NOT adding Authorization header
          },
          body: JSON.stringify({
            username: 'admin',
            password: 'admin123'
          })
        });

        const data = await response.json();

        if (response.ok) {
          log(`‚úÖ Login successful!`, 'success');
          log(`Token received: ${data.token.substring(0, 30)}...`, 'success');
          localStorage.setItem('token', data.token);

          // Check what headers were SENT (we can't directly, but server logs would show)
          log('‚ö†Ô∏è Check server logs to confirm NO Authorization header was sent', 'warning');
        } else {
          log(`‚ùå Login failed: ${data.message}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testLoginWithToken() {
      log('=== TEST 2: Login WITH Existing Token ===', 'info');

      const existingToken = localStorage.getItem('token');
      if (!existingToken) {
        log('‚ö†Ô∏è No token in localStorage. Run Test 1 first.', 'warning');
        return;
      }

      log(`Using existing token: ${existingToken.substring(0, 30)}...`, 'info');

      try {
        // This simulates what would happen if axios interceptor ran on login
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${existingToken}`,  // ‚ö†Ô∏è WRONG - testing what would happen
          },
          body: JSON.stringify({
            username: 'admin',
            password: 'admin123'
          })
        });

        const data = await response.json();

        if (response.ok) {
          log(`‚úÖ Login successful (even with token header)`, 'success');
          log(`New token: ${data.token.substring(0, 30)}...`, 'success');
          log('‚ö†Ô∏è This means backend ignores the token on login endpoint', 'warning');
        } else {
          log(`‚ùå Login failed: ${data.message}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testProtectedEndpoint() {
      log('=== TEST 3: Protected Endpoint (Dashboard) ===', 'info');

      const token = localStorage.getItem('token');
      if (!token) {
        log('‚ùå No token found. Run Test 1 first.', 'error');
        return;
      }

      log(`Using token: ${token.substring(0, 30)}...`, 'info');

      try {
        const response = await fetch(`${API_URL}/api/dashboard?startDate=2025-01-01&endDate=2025-12-31`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,  // ‚úÖ CORRECT - token required here
          },
        });

        if (response.ok) {
          const data = await response.json();
          log(`‚úÖ Dashboard accessed successfully`, 'success');
          log(`Data: ${JSON.stringify(data).substring(0, 100)}...`, 'success');
        } else {
          log(`‚ùå Dashboard access failed: ${response.status} ${response.statusText}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Auto-run on page load
    window.addEventListener('load', () => {
      log('üöÄ Auth Flow Tester Ready', 'success');
      log('Click buttons above to test different scenarios', 'info');

      const token = localStorage.getItem('token');
      if (token) {
        log(`Found existing token: ${token.substring(0, 30)}...`, 'warning');
      } else {
        log('No token in localStorage (clean state)', 'info');
      }
    });
  </script>
</body>
</html>
